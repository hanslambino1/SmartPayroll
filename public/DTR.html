<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartPayroll | DTR</title>
  <link rel="icon" type="image/png" href="SPlogo.png">
  <link rel="stylesheet" href="dtr.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="SPlogo.png" alt="Logo" class="logo">
      </div>
      <ul class="menu">
        <li><a href="DASHBOARD.html"><img src="bar-graph.png" class="icon"> Dashboard</a></li>
        <li><a href="EMPLOYEES.html"><img src="group.png" class="icon"> Employees</a></li>
        <li class="active"><a href="DTR.html"><img src="timetable.png" class="icon"> Daily Time Record</a></li>
        <li><a href="PAYROLL.html"><img src="user.png" class="icon"> Payroll</a></li>
        <li><a href="REPORTS.html"><img src="business-report.png" class="icon"> Reports</a></li>
        <li><a href="SETTINGS.html"><img src="gear.png" class="icon"> Settings</a></li>
      </ul>

      <div class="logout-container">
        <button id="logoutBtn" class="logout-btn">
          <img src="logout.png" class="icon"/>Logout
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main show">
      <h1>Daily Time Record</h1>

      <!-- Filters -->
      <div class="filters-section">
        <label for="coverage">Coverage:</label>
        <select id="coverage">
          <option value="">Select Coverage</option>
          <option value="2025-10-01_to_2025-10-15">10/01/2025–10/15/2025</option>
          <option value="2025-10-16_to_2025-10-30">10/16/2025–10/30/2025</option>
        </select>

        <label for="department">Department:</label>
        <select id="department">
          <option value="all">All</option>
          <option value="Human Resources">Human Resources</option>
          <option value="Information Technology (IT)">Information Technology (IT)</option>
          <option value="Finance">Finance</option>
        </select>
        <button id="filterBtn">Load</button>
      </div>

      <!-- Search -->
      <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Last Name | First Name | Middle Name" />
  </div>

      <div class="dtr-container">
        <div class="employee-list">
          <h3>Employees</h3>
          <ul id="employeeList"></ul>
        </div>

        <div class="dtr-table-container">
          <table class="dtr-table" id="dtrTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Undertime</th>
                <th>Overtime</th>
                <th>Late</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" style="text-align:center;">Select an employee to view DTR</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal-logout">
  <div class="modal-content-logout">
    <div class="modal-header-logout">
      <h3>Confirm Logout</h3>
      <span class="close-btn" id="closeLogout">&times;</span>
    </div>
    <div class="modal-body-logout">
      <p>Are you sure you want to log out of SmartPayroll?</p>
    </div>
    <div class="modal-buttons">
      <button id="confirmLogout" class="confirm-btn">Yes</button>
      <button id="cancelLogout" class="cancel-btn">Cancel</button>
    </div>
  </div>
</div>

  <script>
     // ===== LOGOUT MODAL =====
  const logoutBtn = document.getElementById("logoutBtn");
  const logoutModal = document.getElementById("logoutModal");
  const confirmLogout = document.getElementById("confirmLogout");
  const cancelLogout = document.getElementById("cancelLogout");

  logoutBtn.addEventListener("click", () => logoutModal.style.display = "flex");
  cancelLogout.addEventListener("click", () => logoutModal.style.display = "none");
  confirmLogout.addEventListener("click", () => {
    fetch("/logout").then(() => window.location.href = "/LOGIN.html");
  });
  window.addEventListener("click", e => {
    if (e.target === logoutModal) logoutModal.style.display = "none";
  });




document.addEventListener("DOMContentLoaded", () => {
  const coverageSelect = document.getElementById("coverage");
  const deptSelect = document.getElementById("department");
  const filterBtn = document.getElementById("filterBtn");
  const employeeList = document.getElementById("employeeList");
  const dtrTableBody = document.getElementById("dtrTable").querySelector("tbody");
  const searchInput = document.querySelector(".search-bar input");
  const searchBtn = document.querySelector(".search-btn");
  let allEmployees = []; // store all employees for search

  // Load employees by department
  filterBtn.addEventListener("click", loadEmployees);

  async function loadEmployees() {
    const coverage = coverageSelect.value;
    const dept = deptSelect.value;

    if (!coverage) {
      employeeList.innerHTML = "<li>Please select a coverage period.</li>";
      return;
    }

    try {
      const res = await fetch(`/api/employees?department=${dept}&coverage=${coverage}`);
      const employees = await res.json();

      console.log("Employees loaded:", employees); 

      allEmployees = employees;
      renderEmployeeList(allEmployees);
    } catch (err) {
      console.error(err);
      employeeList.innerHTML = "<li>Error loading employees.</li>";
    }
  }


  // 🔍 Search employees by name
  searchInput.addEventListener("keyup", (e) => {
    if (e.key === "Enter") handleSearch();
    else handleSearch(); // live filter
  });

  function handleSearch() {
  const query = searchInput.value.trim().toLowerCase();

  // if no employees loaded yet
  if (!allEmployees.length) {
    employeeList.innerHTML = "<li>No employees loaded. Please click 'Load'.</li>";
    return;
  }

  if (!query) {
    renderEmployeeList(allEmployees);
    return;
  }

  const filtered = allEmployees.filter(emp => 
    emp.name.toLowerCase().includes(query)
  );

  renderEmployeeList(filtered);
}


  // Render employee list + click behavior
  function renderEmployeeList(list) {
    if (!list.length) {
      employeeList.innerHTML = "<li>No employees found.</li>";
      return;
    }

    employeeList.innerHTML = list.map(emp => `
      <li data-id="${emp.id}" class="employee-item">${emp.name} — ${emp.dept}</li>
    `).join("");

    document.querySelectorAll(".employee-item").forEach(item => {
      item.addEventListener("click", async () => {
        document.querySelectorAll(".employee-item").forEach(li => li.classList.remove("active"));
        item.classList.add("active");

        const id = item.dataset.id;
        const coverage = coverageSelect.value;
        await showEmployeeDTR(id, coverage);
      });
    });
  }

  // Load DTR records per employee
  async function showEmployeeDTR(employeeId, coverage) {
    try {
      const res = await fetch(`/api/dtr/${employeeId}?coverage=${coverage}`);
      const dtr = await res.json();
      if (!res.ok) throw new Error("Failed to load DTR");

      if (!dtr.records || dtr.records.length === 0) {
        dtrTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No DTR records found</td></tr>`;
        return;
      }

      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      };

      const formatTime = (timeStr) => {
        if (!timeStr || timeStr === "0000-00-00 00:00:00") return "";
        const date = new Date(`1970-01-01T${timeStr}`);
        if (isNaN(date)) return timeStr;
        return date.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
      };

      dtrTableBody.innerHTML = dtr.records.map(r => {
        const { late, undertime, overtime } = calculateDTR(r.time_in, r.time_out);

        return `
          <tr data-id="${r.id}">
          <td>${formatDate(r.date)}</td>
          <td>${formatTime(r.time_in)}</td>
          <td>${formatTime(r.time_out)}</td>
          <td contenteditable="true" class="editable undertime">${undertime}</td>
          <td contenteditable="true" class="editable overtime">${overtime}</td>
          <td contenteditable="true" class="editable late">${late}</td>
        </tr>
      `;
    }).join("");


      document.querySelectorAll(".editable").forEach(cell => {
        cell.addEventListener("blur", async (e) => {
          const row = e.target.closest("tr");
          const id = row.dataset.id;
          const undertime = row.querySelector(".undertime").innerText.trim();
          const overtime = row.querySelector(".overtime").innerText.trim();
          const late = row.querySelector(".late").innerText.trim();

          try {
            await fetch(`/api/dtr/update/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ undertime, overtime, late })
            });
          } catch (err) {
            console.error("Error saving DTR update:", err);
          }
        });
      });

    } catch (err) {
      console.error(err);
      dtrTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error loading DTR</td></tr>`;
    }
  }

  // Fade animations
  const main = document.querySelector(".main");
  setTimeout(() => main.classList.add("show"), 50);

  document.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      main.classList.remove("show");
      main.classList.add("hide");
      setTimeout(() => {
        window.location.href = link.href;
      }, 500);
    });
  });
});

// Calculate Late, Undertime, Overtime in minutes
function calculateDTR(timeIn, timeOut, workStart="08:00:00", workEnd="16:00:00") {
  const msInMinute = 60000;

  const start = new Date(`1970-01-01T${workStart}`);
  const end = new Date(`1970-01-01T${workEnd}`);
  const inTime = timeIn ? new Date(`1970-01-01T${timeIn}`) : null;
  const outTime = timeOut ? new Date(`1970-01-01T${timeOut}`) : null;

  const late = inTime ? Math.max(0, Math.floor((inTime - start) / msInMinute)) : 0;
  const undertime = outTime ? Math.max(0, Math.floor((end - outTime) / msInMinute)) : 0;
  const overtime = outTime ? Math.max(0, Math.floor((outTime - end) / msInMinute)) : 0;

  return { late, undertime, overtime };
}

</script>
</body>
</html>
