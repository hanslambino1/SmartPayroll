<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartPayroll | Employees</title>
  <link rel="icon" type="image/png" href="SPlogo.png" />
  <link rel="stylesheet" href="employees.css" />
  <script src="script.js" defer></script>
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="SPlogo.png" alt="Logo" class="logo" />
      </div>
      <ul class="menu">
        <li><a href="DASHBOARD.html"><img src="bar-graph.png" class="icon"> Dashboard</a></li>
        <li class="active"><a href="EMPLOYEES.html"><img src="group.png" class="icon"> Employees</a></li>
        <li><a href="DTR.html"><img src="timetable.png" class="icon"> Daily Time Record</a></li>
        <li><a href="PAYROLL.html"><img src="user.png" class="icon"> Payroll</a></li>
        <li><a href="REPORTS.html"><img src="business-report.png" class="icon"> Reports</a></li>
        <li><a href="SETTINGS.html"><img src="gear.png" class="icon"> Settings</a></li>
      </ul>

      <div class="logout-container">
        <button id="logoutBtn" class="logout-btn">
          <img src="logout.png" class="icon"/>Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main show">
      <h1>Employees</h1>

      <!-- Search Bar -->
      <div class="search-bar">
        <input type="text" placeholder="Last Name | First Name | Middle Name" />
        <button class="search-btn">üîç</button>
      </div>

      <!-- Resigned Label -->
      <div class="resigned-label" id="resignedBtn">Resigned Employees</div>

      <!-- Employees Table -->
      <div class="table-container">
        <table id="employeesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Dept</th>
              <th>Position</th>
              <th>Status</th>
              <th>Date Hired</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Add Employee Form -->
      <div class="form-container">
        <h3>Add New Employee</h3>
        <form id="addEmployeeForm">
          <div class="input-group">
            <input type="text" name="name" placeholder="Employee Name" required />
          </div>

          <!-- Department -->
          <div class="input-group">
            <select name="dept" required>
              <option value="">Select Department</option>
              <option>Human Resources</option>
              <option>Finance</option>
              <option>Information Technology (IT)</option>
            </select>
          </div>

          <!-- Position -->
          <div class="input-group">
            <select name="position" required>
              <option value="">Select Position</option>
              <option>Financial Officer</option>
              <option>Maintenance Personnel</option>
              <option>Payroll Officer</option>
            </select>
          </div>

          <!-- Status -->
          <div class="input-group">
            <select name="status" required>
              <option value="">Select Status</option>
              <option>Regular</option>
              <option>Probationary</option>
            </select>
          </div>

          <!-- Date Hired -->
          <div class="input-group">
            <input type="date" name="date_hired" required />
          </div>

          <!-- Salary -->
          <div class="input-group">
            <input type="number" step="0.01" name="salary" placeholder="Salary" required />
          </div>

          <!-- Emergency Contact -->
          <div class="input-group">
            <input type="text" name="emergency_contact_name" placeholder="Emergency Contact Name" required />
          </div>

          <div class="input-group">
            <input type="text" name="emergency_contact_no" placeholder="Emergency Contact Number" required />
          </div>

          <!-- Personal Contact -->
          <div class="input-group">
            <input type="text" name="contact_no" placeholder="Employee Contact Number" required />
          </div>

          <!-- Address -->
          <div class="input-group">
            <input type="text" name="address" placeholder="Address" required />
          </div>

          <!-- SSS -->
          <div class="input-group">
            <input type="text" name="sss_no" placeholder="SSS Number" />
          </div>

          <!-- PhilHealth -->
          <div class="input-group">
            <input type="text" name="philhealth_no" placeholder="PhilHealth Number" />
          </div>

          <!-- Pag-ibig -->
          <div class="input-group">
            <input type="text" name="pagibig_no" placeholder="Pag-ibig Number" />
          </div>

          <!-- ATM -->
          <div class="input-group">
            <input type="text" name="atm_no" placeholder="ATM Number" />
          </div>

          <button type="submit" class="add-btn">Add Employee</button>
        </form>
      </div>
    </main>
  </div>

  <!-- Edit Employee Modal -->
<div id="editModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Employee</h2>
      <button id="closeModal" class="close">&times;</button>
    </div>

    <form id="editEmployeeForm" class="modal-body">
      <input type="hidden" name="id" />

      <div class="form-group">
        <label>Employee Name</label>
        <input type="text" name="name" placeholder="Employee Name" required />
      </div>

      <div class="form-group">
        <label>Department</label>
        <select name="dept" required>
          <option>Human Resources</option>
          <option>Finance</option>
          <option>Information Technology (IT)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Position</label>
        <select name="position" required>
          <option>Financial Officer</option>
          <option>Maintenance Personnel</option>
          <option>Payroll Officer</option>
        </select>
      </div>

      <div class="form-group">
        <label>Status</label>
        <select name="status" required>
          <option>Regular</option>
          <option>Probationary</option>
        </select>
      </div>

      <div class="form-group">
        <label>Date Hired</label>
        <input type="date" name="date_hired" />
      </div>

      <div class="form-group">
        <label>Salary</label>
        <input type="number" step="0.01" name="salary" placeholder="Salary" />
      </div>

      <div class="form-group">
        <label>Emergency Contact Name</label>
        <input type="text" name="emergency_contact_name" placeholder="Emergency Contact Name" />
      </div>

      <div class="form-group">
        <label>Emergency Contact Number</label>
        <input type="text" name="emergency_contact_no" placeholder="Emergency Contact Number" />
      </div>

      <div class="form-group">
        <label>Employee Contact Number</label>
        <input type="text" name="contact_no" placeholder="Employee Contact Number" />
      </div>

      <div class="form-group">
        <label>Address</label>
        <input type="text" name="address" placeholder="Address" />
      </div>

      <div class="form-group">
        <label>SSS Number</label>
        <input type="text" name="sss_no" placeholder="SSS Number" />
      </div>

      <div class="form-group">
        <label>PhilHealth Number</label>
        <input type="text" name="philhealth_no" placeholder="PhilHealth Number" />
      </div>

      <div class="form-group">
        <label>Pag-ibig Number</label>
        <input type="text" name="pagibig_no" placeholder="Pag-ibig Number" />
      </div>

      <div class="form-group">
        <label>ATM Number</label>
        <input type="text" name="atm_no" placeholder="ATM Number" />
      </div>

      <div class="form-actions">
        <button type="submit" class="save-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>


    <!-- Footer Buttons -->
    <div class="modal-footer">
      <button class="btn-cancel" id="cancelEdit">Cancel</button>
      <button type="submit" form="editEmployeeForm" class="btn-save">Save Changes</button>
    </div>
  </div>
</div>


  <script>
    // Load Employees
document.addEventListener("DOMContentLoaded", loadEmployees);
async function loadEmployees() {
  try {
    const res = await fetch("/api/employees");
    const employees = await res.json();

    const tbody = document.querySelector("#employeesTable tbody");
    tbody.innerHTML = "";

    if (employees.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No employees found</td></tr>`;
      return;
    }

    employees.forEach(emp => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${emp.id}</td>
        <td>${emp.name}</td>
        <td>${emp.dept}</td>
        <td>${emp.position}</td>
        <td>${emp.status}</td>
        <td>${emp.date_hired ? emp.date_hired.split("T")[0] : ""}</td>
        <td>
          <button class="edit-btn" data-id="${emp.id}">Edit</button>
          <button class="resign-btn" data-id="${emp.id}">Resign</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("‚ùå Error loading employees:", err);
  }
}

// Handle Resign Button
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("resign-btn")) {
    const id = e.target.dataset.id;
    if (!confirm("Are you sure you want to mark this employee as resigned?")) return;

    try {
      const res = await fetch(`/api/employees/resign/${id}`, {
        method: "POST"
      });

      const result = await res.json();

      if (res.ok) {
        alert("‚úÖ Employee moved to resigned list!");
        loadEmployees(); // refresh table
      } else {
        alert("‚ùå " + result.error);
      }
    } catch (err) {
      console.error("Error resigning employee:", err);
      alert("‚ùå Error moving employee to resigned list");
    }
  }
});

   // Handle Edit button click
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("edit-btn")) {
    const id = e.target.dataset.id;

    try {
      const res = await fetch(`/api/employees/${id}`);
      const emp = await res.json();

      if (res.ok) {
        const form = document.getElementById("editEmployeeForm");
        for (const key in emp) {
      if (form[key]) {
        // Format date for date input
        if (key === "date_hired" && emp[key]) {
          form[key].value = emp[key].split("T")[0]; // YYYY-MM-DD format
        } else {
          form[key].value = emp[key] || "";
        }
      }
    }
        document.getElementById("editModal").classList.remove("hidden");
      } else {
        alert("Error loading employee details");
      }
    } catch (err) {
      console.error(err);
      alert("Error loading employee details");
    }
  }
});

// Close modal
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("editModal").classList.add("hidden");
});
document.getElementById("cancelEdit").addEventListener("click", () => {
  document.getElementById("editModal").classList.add("hidden");
});

// Handle Save Changes
document.getElementById("editEmployeeForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const id = form.id.value;

  const data = Object.fromEntries(new FormData(form).entries());

  try {
    const res = await fetch(`/api/employees/update/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    if (res.ok) {
      alert("‚úÖ Employee updated successfully!");
      document.getElementById("editModal").classList.add("hidden");
      loadEmployees(); // refresh table
    } else {
      alert("‚ùå Error: " + result.error);
    }
  } catch (err) {
    console.error("Error saving changes:", err);
    alert("‚ùå Error saving changes");
  }
});

    // Save Edit
    document.getElementById("editEmployeeForm").addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));

      try {
        const res = await fetch(`/api/employees/update/${data.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const result = await res.json();

        if (res.ok) {
          alert("‚úÖ Employee updated successfully!");
          document.getElementById("editModal").classList.add("hidden");
          loadEmployees();
        } else {
          alert("‚ùå " + result.error);
        }
      } catch (err) {
        alert("Error saving changes.");
        console.error(err);
      }
    });

    // Add Employee
    document.getElementById("addEmployeeForm").addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      try {
        const res = await fetch("/api/employees/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const result = await res.json();

        if (res.ok) {
          alert("‚úÖ Employee added successfully!");
          form.reset();
          loadEmployees();
        } else {
          alert("‚ùå " + result.error);
        }
      } catch (err) {
        alert("Server error while adding employee.");
        console.error(err);
      }
    });

    document.addEventListener("DOMContentLoaded", loadEmployees);

    // Search Employees
document.querySelector(".search-btn").addEventListener("click", searchEmployees);
document.querySelector(".search-bar input").addEventListener("keyup", (e) => {
  if (e.key === "Enter") searchEmployees();
});

function searchEmployees() {
  const query = document.querySelector(".search-bar input").value.toLowerCase().trim();
  const rows = document.querySelectorAll("#employeesTable tbody tr");

  rows.forEach(row => {
    const id = row.children[0].textContent.toLowerCase();
    const name = row.children[1].textContent.toLowerCase();
    const dept = row.children[2].textContent.toLowerCase();
    const position = row.children[3].textContent.toLowerCase();
    const status = row.children[4].textContent.toLowerCase();

    // Show employee if any field matches the query
    if (
      id.includes(query) ||
      name.includes(query) ||
      dept.includes(query) ||
      position.includes(query) ||
      status.includes(query)
    ) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}


    document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to log out?")) {
      fetch("/logout")
        .then(() => window.location.href = "/LOGIN.html")
        .catch(err => alert("Error logging out. Please try again."));
    }
  });

  /// Fade animations
  const main = document.querySelector(".main");

  // Fade in when page loads
  setTimeout(() => {
    main.classList.add("show");
  }, 50);

  // Fade out when leaving page
  document.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      main.classList.remove("show");
      main.classList.add("hide");
      setTimeout(() => {
        window.location.href = link.href;
      }, 500); 
    });
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to log out?")) {
      fetch("/logout")
        .then(() => window.location.href = "/LOGIN.html")
        .catch(err => alert("Error logging out. Please try again."));
    }
  });

  document.getElementById("resignedBtn").addEventListener("click", () => {
  window.location.href = "RESIGNED.html"; 
});




  </script>
</body>
</html>

