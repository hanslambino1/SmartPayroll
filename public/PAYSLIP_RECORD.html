<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Payroll - Payslip Records</title>
  <link rel="stylesheet" href="payslip_record.css">
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="logo-section">
      <img src="SPlogo.png" alt="Smart Payroll Logo">
      <h1><strong>Smart</strong> <span class="blue">Payroll</span></h1>
    </div>
    <nav class="nav">
      <a href="homepage.html">Home</a>
      <span>|</span>
      <a href="payslip.html" class="active">My Payslip</a>
      <span>|</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>
  </header>

  <!-- ===== MAIN CONTAINER ===== -->
  <main class="container">
    <div class="records-header">
      <h2>Payslip Records</h2>
      <button class="back-btn" onclick="window.location.href='payslip.html'">← Back to Payslip</button>
    </div>

    <div class="table-wrapper">
      <table class="records-table">
        <thead>
          <tr>
            <th>Payroll Period</th>
            <th>Date Issued</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <!-- Dynamic rows inserted here -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- ===== MODAL ===== -->
  <div id="payslipModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Payslip Details</h2>
        <span class="close-btn" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button class="close-btn-footer" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
    // Logout function
    function logout() {
      window.location.href = "employee_login.html";
    }

    // ===== Fetch Payslip Records Dynamically =====
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Get logged-in employee
        const res = await fetch("/api/employees/me", { credentials: "include" });
        if (!res.ok) throw new Error("Not logged in");
        const emp = await res.json();
        const employeeID = emp.id;

        // Fetch all payslip periods for this employee
        const periodsRes = await fetch(`/api/employees/payslip/periods?employee_id=${employeeID}`, { credentials: "include" });
        if (!periodsRes.ok) throw new Error("Failed to load payslip records");
        const periods = await periodsRes.json();

        const tbody = document.getElementById("recordsBody");
        tbody.innerHTML = periods.map(p => `
          <tr>
            <td>${p.coverage}</td>
            <td>${new Date(p.created_at).toLocaleDateString()}</td>
            <td><span class="paid">Done</span></td>
            <td><button class="view-btn" onclick="openModal(${p.id})">View</button></td>
          </tr>
        `).join("");

      } catch (err) {
        console.error(err);
        alert("Failed to load payslip records.");
      }
    });

    // ===== Load Payslip Details in Modal =====
    async function openModal(payrollId) {
      try {
        const res = await fetch(`/api/employees/payslip/${payrollId}`, { credentials: "include" });
        if (!res.ok) throw new Error("Payslip not found");
        const data = await res.json();

        const body = document.getElementById("modalBody");
        body.innerHTML = `
          <table class="payslip-table">
            <tr><th>Employee</th><td>${data.employee_name}</td></tr>
            <tr><th>Position</th><td>${data.position}</td></tr>
            <tr><th>Department</th><td>${data.department}</td></tr>
            <tr><th>Coverage</th><td>${data.coverage}</td></tr>

            <tr><th colspan="2"><hr></th></tr>

            <tr><th>Basic Salary (Monthly)</th><td>₱ ${Number(data.basic_salary).toLocaleString()}</td></tr>
            <tr><th>Daily Rate</th><td>₱ ${Number(data.daily_rate || 0).toLocaleString()}</td></tr>
            <tr><th>Total Earnings</th><td>₱ ${Number(data.total_earnings || 0).toLocaleString()}</td></tr>
            <tr><th>Late Deduction</th><td>₱ ${Number(data.late_deduction || 0).toLocaleString()}</td></tr>
            <tr><th>Undertime Deduction</th><td>₱ ${Number(data.undertime_deduction || 0).toLocaleString()}</td></tr>
            <tr><th>Overtime Pay</th><td>₱ ${Number(data.overtime_pay || 0).toLocaleString()}</td></tr>

            <tr><th colspan="2"><hr></th></tr>

            <tr><th>SSS</th><td>₱ ${Number(data.sss || 0).toLocaleString()}</td></tr>
            <tr><th>PhilHealth</th><td>₱ ${Number(data.philhealth || 0).toLocaleString()}</td></tr>
            <tr><th>Pag-IBIG</th><td>₱ ${Number(data.pagibig || 0).toLocaleString()}</td></tr>
            <tr><th>Total Deductions</th><td>₱ ${Number(data.total_deductions || 0).toLocaleString()}</td></tr>
            <tr><th>Net Pay</th><td>₱ ${Number(data.net_pay || 0).toLocaleString()}</td></tr>
            <tr><th>Date Generated</th><td>${new Date(data.created_at).toLocaleString()}</td></tr>
          </table>
        `;
        document.getElementById("payslipModal").style.display = "block";

      } catch (err) {
        console.error(err);
        alert("Failed to load payslip details.");
      }
    }

    function closeModal() {
      document.getElementById("payslipModal").style.display = "none";
    }

    // Close modal if clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById("payslipModal");
      if (event.target == modal) modal.style.display = "none";
    }
  </script>

</body>
</html>
