<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartPayroll | DTR</title>
  <link rel="icon" type="image/png" href="SPlogo.png">
  <link rel="stylesheet" href="dtr.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="SPlogo.png" alt="Logo" class="logo">
      </div>
      <ul class="menu">
        <li><a href="DASHBOARD.html"><img src="bar-graph.png" class="icon"> Dashboard</a></li>
        <li><a href="EMPLOYEES.html"><img src="group.png" class="icon"> Employees</a></li>
        <li class="active"><a href="DTR.html"><img src="timetable.png" class="icon"> Daily Time Record</a></li>
        <li><a href="PAYROLL.html"><img src="user.png" class="icon"> Payroll</a></li>
        <li><a href="REPORTS.html"><img src="business-report.png" class="icon"> Reports</a></li>
        <li><a href="SETTINGS.html"><img src="gear.png" class="icon"> Settings</a></li>
      </ul>

      <div class="logout-container">
        <button id="logoutBtn" class="logout-btn">
          <img src="logout.png" class="icon"/>Logout
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main show">
      <h1>Daily Time Record</h1>

      <!-- Filters -->
      <div class="filters-section">
        <label for="coverage">Coverage:</label>
        <select id="coverage">
          <option value="">Select Coverage</option>
          <option value="2025-10-01_to_2025-10-15">10/01/2025–10/15/2025</option>
          <option value="2025-10-16_to_2025-10-30">10/16/2025–10/30/2025</option>
        </select>

        <label for="department">Department:</label>
        <select id="department">
          <option value="all">All Departments</option>
          <option value="HR">Human Resources</option>
          <option value="IT">IT</option>
          <option value="Finance">Finance</option>
        </select>

        <button id="filterBtn">Load</button>
      </div>

      <div class="dtr-container">
        <div class="employee-list">
          <h3>Employees</h3>
          <ul id="employeeList"></ul>
        </div>

        <div class="dtr-table-container">
          <table class="dtr-table" id="dtrTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Undertime</th>
                <th>Overtime</th>
                <th>Late</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" style="text-align:center;">Select an employee to view DTR</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const coverageSelect = document.getElementById("coverage");
  const deptSelect = document.getElementById("department");
  const filterBtn = document.getElementById("filterBtn");
  const employeeList = document.getElementById("employeeList");
  const dtrTableBody = document.getElementById("dtrTable").querySelector("tbody");

  // Load employees by department
  filterBtn.addEventListener("click", loadEmployees);

  async function loadEmployees() {
    const coverage = coverageSelect.value;
    const dept = deptSelect.value;

    if (!coverage) {
      employeeList.innerHTML = "<li>Please select a coverage period.</li>";
      return;
    }

    try {
      const res = await fetch(`/api/employees?department=${dept}`);
      if (!res.ok) throw new Error("Failed to fetch employees");
      const employees = await res.json();

      if (!employees.length) {
        employeeList.innerHTML = "<li>No employees found.</li>";
        return;
      }

      employeeList.innerHTML = employees.map(emp => `
        <li data-id="${emp.id}" class="employee-item">${emp.name} — ${emp.dept}</li>
      `).join("");

      document.querySelectorAll(".employee-item").forEach(item => {
        item.addEventListener("click", async () => {
          document.querySelectorAll(".employee-item").forEach(li => li.classList.remove("active"));
          item.classList.add("active");

          const id = item.dataset.id;
          await showEmployeeDTR(id, coverage);
        });
      });
    } catch (err) {
      console.error(err);
      employeeList.innerHTML = "<li>Error loading employees.</li>";
    }
  }

  // Load DTR records per employee
  async function showEmployeeDTR(employeeId, coverage) {
  try {
    const res = await fetch(`/api/dtr/${employeeId}?coverage=${coverage}`);
    const dtr = await res.json();
    if (!res.ok) throw new Error("Failed to load DTR");

    if (!dtr.records || dtr.records.length === 0) {
      dtrTable.innerHTML = `<tr><td colspan="7" style="text-align:center;">No DTR records found</td></tr>`;
      return;
    }

    // Format date and time display
    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    };

    // Format time
    const formatTime = (timeStr) => {
  if (!timeStr || timeStr === "0000-00-00 00:00:00") return "";
  // Dummy to know if it works
  const date = new Date(`1970-01-01T${timeStr}`);
  if (isNaN(date)) return timeStr; 
  return date.toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
  });
};


    dtrTable.innerHTML = `
      <tr>
        <th>Date</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Undertime</th>
        <th>Overtime</th>
        <th>Late</th>
      </tr>
      ${dtr.records.map(r => `
        <tr data-id="${r.id}">
          <td>${formatDate(r.date)}</td>
          <td>${formatTime(r.time_in)}</td>
          <td>${formatTime(r.time_out)}</td>
          <td contenteditable="true" class="editable undertime">${r.undertime || 0}</td>
          <td contenteditable="true" class="editable overtime">${r.overtime || 0}</td>
          <td contenteditable="true" class="editable late">${r.late || 0}</td>
        </tr>
      `).join("")}
    `;

    // Save edits
    document.querySelectorAll(".editable").forEach(cell => {
      cell.addEventListener("blur", async (e) => {
        const row = e.target.closest("tr");
        const id = row.dataset.id;
        const undertime = row.querySelector(".undertime").innerText.trim();
        const overtime = row.querySelector(".overtime").innerText.trim();
        const late = row.querySelector(".late").innerText.trim();

        try {
          await fetch(`/api/dtr/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ undertime, overtime, late })
          });
        } catch (err) {
          console.error("Error saving DTR update:", err);
        }
      });
    });

  } catch (err) {
    console.error(err);
    dtrTable.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error loading DTR</td></tr>`;
  }
}


  // Fade animations
  const main = document.querySelector(".main");

  // Fade in
  setTimeout(() => {
    main.classList.add("show");
  }, 50);

  // Fade out on navigation
  document.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      main.classList.remove("show");
      main.classList.add("hide");
      setTimeout(() => {
        window.location.href = link.href;
      }, 500);
    });
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to log out?")) {
      fetch("/logout")
        .then(() => window.location.href = "/LOGIN.html")
        .catch(err => alert("Error logging out. Please try again."));
    }
  });
});
</script>
</body>
</html>
